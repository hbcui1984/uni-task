# 项目高级功能实现报告

> 更新日期：2025-11-17
> 功能版本：v2.2.0

---

## 功能概述

本次更新为项目管理系统添加了三个核心高级功能：
1. **项目封面/图标上传**
2. **项目归档功能**
3. **权限控制**（仅管理员可编辑）

---

## 一、项目封面/图标上传

### 功能描述

允许项目管理员为项目上传自定义封面图片，增强项目识别度和美观性。

### 技术实现

#### 数据库 Schema 更新

```json
{
  "cover": {
    "bsonType": "object",
    "title": "项目封面/图标",
    "properties": {
      "url": { "bsonType": "string", "title": "图片URL" },
      "name": { "bsonType": "string", "title": "图片名称" },
      "size": { "bsonType": "number", "title": "图片大小（字节）" }
    }
  }
}
```

#### 功能特性

✅ **图片选择**：
- 支持从相册选择或相机拍照
- 自动压缩图片

✅ **文件限制**：
- 支持格式：JPG、PNG
- 最大文件大小：2MB
- 建议尺寸：400×300

✅ **云存储**：
- 自动上传到 uniCloud 云存储
- 存储路径：`project-covers/{项目ID}_{时间戳}.jpg`

✅ **预览和管理**：
- 实时预览上传的封面
- 悬浮显示删除按钮
- 删除时自动清理云存储文件

#### 用户界面

```
┌─────────────────────────────────┐
│  未上传封面时：                  │
│  ┌─────────────────────────┐   │
│  │   📷 图标               │   │
│  │  点击上传封面           │   │
│  │  建议尺寸 400×300       │   │
│  └─────────────────────────┘   │
└─────────────────────────────────┘

┌─────────────────────────────────┐
│  已上传封面时：                  │
│  ┌─────────────────────────┐   │
│  │   [封面图片预览]        │   │
│  │                         │   │
│  │         [删除按钮 🗑️]   │   │
│  └─────────────────────────┘   │
└─────────────────────────────────┘
```

#### 核心代码

**上传封面**：
```javascript
handleUploadCover() {
  uni.chooseImage({
    count: 1,
    sizeType: ['compressed'],
    success: (res) => {
      // 检查文件大小
      uni.getFileInfo({
        filePath: res.tempFilePaths[0],
        success: (info) => {
          if (info.size > 2 * 1024 * 1024) {
            return uni.showToast({ title: '图片大小不能超过2MB' })
          }

          // 上传到云存储
          uniCloud.uploadFile({
            filePath: res.tempFilePaths[0],
            cloudPath: `project-covers/${projectId}_${Date.now()}.jpg`,
            success: (uploadRes) => {
              this.formData.cover = {
                url: uploadRes.fileID,
                name: uploadRes.fileID.split('/').pop(),
                size: info.size
              }
            }
          })
        }
      })
    }
  })
}
```

**删除封面**：
```javascript
handleRemoveCover() {
  uni.showModal({
    title: '确认删除',
    content: '确定要删除项目封面吗？',
    success: (res) => {
      if (res.confirm) {
        // 删除云存储文件
        uniCloud.deleteFile({
          fileList: [this.formData.cover.url]
        })
        this.formData.cover = null
      }
    }
  })
}
```

### 样式设计

- **虚线边框**：未上传时显示虚线框，提示用户点击
- **悬浮效果**：鼠标悬停时边框变为绿色
- **渐变遮罩**：封面预览时底部显示半透明渐变遮罩
- **响应式布局**：移动端 200px 高度，PC 端 240px 高度

---

## 二、项目归档功能

### 功能描述

允许项目管理员将不活跃的项目归档，归档后的项目不会出现在活跃项目列表中，但数据保留可访问。

### 技术实现

#### 数据库 Schema 更新

```json
{
  "archived": {
    "bsonType": "bool",
    "title": "是否已归档",
    "defaultValue": false
  },
  "archived_date": {
    "bsonType": "timestamp",
    "title": "归档时间"
  }
}
```

#### 功能特性

✅ **归档操作**：
- 仅项目管理员可归档
- 二次确认弹窗
- 自动记录归档时间

✅ **取消归档**：
- 已归档项目可重新激活
- 清除归档时间戳

✅ **列表过滤**：
- 项目列表自动过滤已归档项目
- 查询条件：`archived != true`

✅ **状态显示**：
- 已归档项目显示归档状态和时间
- 图标区分归档/未归档状态

#### 用户界面

```
┌──────────────────────────────────────┐
│  项目设置                             │
│                                       │
│  ✓ 归档项目               [归档项目] │
│  归档后，项目将从活跃列表中移除，     │
│  但数据会被保留                       │
└──────────────────────────────────────┘

         ↓ 归档后 ↓

┌──────────────────────────────────────┐
│  项目设置                             │
│                                       │
│  ✓ 项目已归档           [取消归档]   │
│  归档的项目不会出现在活跃项目列表中， │
│  但仍可查看和访问                     │
│  归档时间：2025-11-17 14:30          │
└──────────────────────────────────────┘
```

#### 核心代码

**切换归档状态**：
```javascript
handleToggleArchive() {
  const isArchiving = !this.formData.archived
  const message = isArchiving
    ? '归档后项目将从活跃列表中移除，确认归档吗？'
    : '确认要取消归档吗？'

  uni.showModal({
    title: isArchiving ? '确认归档' : '取消归档',
    content: message,
    success: (res) => {
      if (res.confirm) {
        this.formData.archived = isArchiving
        this.formData.archived_date = isArchiving ? Date.now() : null
        this.submitForm(this.formData)
      }
    }
  })
}
```

**项目列表过滤**：
```html
<unicloud-db
  collection="opendb-projects"
  where="(managers==$cloudEnv_uid || members==$cloudEnv_uid) && archived != true"
>
</unicloud-db>
```

### 样式设计

- **状态指示器**：使用图标（✓/✗）区分归档状态
- **浅灰背景**：归档设置区域使用浅灰色背景
- **颜色区分**：归档按钮为橙色警告样式
- **时间显示**：已归档项目显示归档时间

---

## 三、权限控制（仅管理员可编辑）

### 功能描述

实现基于角色的访问控制（RBAC），仅项目管理员可编辑项目信息，普通成员只有查看权限。

### 技术实现

#### 权限检查逻辑

```javascript
// 1. 获取当前用户ID
const userInfo = uni.getStorageSync('uni-id-pages-userInfo')
this.currentUserId = userInfo._id

// 2. 检查是否是管理员
checkIsManager() {
  if (!this.formData.managers || !this.currentUserId) {
    this.isManager = false
    return
  }
  this.isManager = this.formData.managers.includes(this.currentUserId)
}

// 3. 页面加载时自动检查
async getDetail(id) {
  const res = await db.collection('opendb-projects').doc(id).get()
  this.formData = res.result.data[0]
  this.checkIsManager() // 检查权限
}
```

#### 权限控制范围

| 操作 | 管理员 | 普通成员 |
|------|--------|----------|
| 查看项目信息 | ✅ | ✅ |
| 修改项目名称 | ✅ | ❌ 禁用 |
| 修改项目描述 | ✅ | ❌ 禁用 |
| 上传/删除封面 | ✅ | ❌ 提示无权限 |
| 归档/取消归档 | ✅ | ❌ 不显示 |
| 管理成员 | ✅ | ✅ |
| 保存修改 | ✅ | ❌ 按钮禁用 |

#### UI 状态控制

**输入框禁用**：
```html
<uni-easyinput
  v-model="formData.name"
  :disabled="!isManager"
/>

<textarea
  v-model="formData.description"
  :disabled="!isManager"
/>
```

**功能按钮**：
```html
<!-- 上传封面 -->
<view @click="handleUploadCover">
  <!-- 管理员检查在方法内部 -->
</view>

<!-- 归档设置 -->
<view class="section" v-if="isManager">
  <!-- 仅管理员可见 -->
</view>

<!-- 保存按钮 -->
<button
  type="primary"
  :disabled="!isManager"
>
  保存修改
</button>
```

#### 权限提示

普通成员访问时显示黄色提示框：

```
┌────────────────────────────────────┐
│ ⚠️ 您不是项目管理员，只能查看项目  │
│    信息，无法进行修改              │
└────────────────────────────────────┘
```

### 样式设计

- **禁用状态**：输入框显示灰色背景，禁止编辑
- **权限提示**：黄色背景 + 橙色边框 + 警告图标
- **按钮禁用**：保存按钮变为灰色不可点击

---

## 完整功能集成

### 项目设置页面结构

```
┌──────────────────────────────────────┐
│  项目设置（绿色渐变标题）             │
├──────────────────────────────────────┤
│  📝 基本信息                          │
│  ├─ 项目封面 [上传/预览/删除]        │
│  ├─ 项目名称 [启用/禁用]             │
│  └─ 项目描述 [启用/禁用]             │
├──────────────────────────────────────┤
│  📊 项目统计                          │
│  └─ 成员/任务/完成率                 │
├──────────────────────────────────────┤
│  👥 成员管理                          │
│  └─ 成员列表 + [管理成员]            │
├──────────────────────────────────────┤
│  ⚙️ 项目设置 (仅管理员可见)          │
│  └─ 归档状态 + [归档/取消归档]       │
├──────────────────────────────────────┤
│  [取消] [保存修改]                    │
├──────────────────────────────────────┤
│  ⚠️ 权限提示 (普通成员可见)          │
└──────────────────────────────────────┘
```

---

## 使用流程

### 管理员操作流程

#### 1. 上传项目封面
```
进入项目设置
  ↓
点击"点击上传封面"区域
  ↓
选择图片（相册/相机）
  ↓
自动上传到云存储
  ↓
预览封面，可随时删除
```

#### 2. 归档项目
```
进入项目设置
  ↓
滚动到"项目设置"区域
  ↓
点击"归档项目"按钮
  ↓
确认归档操作
  ↓
项目从活跃列表中移除
  ↓
记录归档时间
```

#### 3. 取消归档
```
进入已归档项目设置
  ↓
点击"取消归档"按钮
  ↓
确认操作
  ↓
项目恢复到活跃列表
  ↓
清除归档时间
```

### 普通成员查看流程

```
进入项目设置
  ↓
看到权限提示（黄色框）
  ↓
所有输入框为禁用状态
  ↓
只能查看项目信息
  ↓
无法上传封面
  ↓
无法看到归档设置
  ↓
保存按钮为禁用状态
```

---

## 数据库更新说明

### 必需操作

**上传 Schema 到云端**：

1. 使用 HBuilderX：
   - 右键 `opendb-projects.schema.json`
   - 选择"上传 DB Schema"

2. 使用 Web 控制台：
   - 访问 uniCloud 控制台
   - 进入云数据库 → Schema
   - 找到 `opendb-projects`
   - 更新 Schema 定义

### Schema 变更摘要

```diff
+ "cover": {
+   "bsonType": "object",
+   "title": "项目封面/图标",
+   "properties": {
+     "url": { "bsonType": "string" },
+     "name": { "bsonType": "string" },
+     "size": { "bsonType": "number" }
+   }
+ }

+ "archived": {
+   "bsonType": "bool",
+   "title": "是否已归档",
+   "defaultValue": false
+ }

+ "archived_date": {
+   "bsonType": "timestamp",
+   "title": "归档时间"
+ }
```

---

## 性能优化

### 封面上传优化

- ✅ **图片压缩**：选择图片时自动压缩
- ✅ **大小限制**：客户端检查 2MB 限制，避免无效上传
- ✅ **异步上传**：使用 loading 提示，不阻塞 UI

### 权限检查优化

- ✅ **本地缓存**：用户信息从 localStorage 读取
- ✅ **一次检查**：页面加载时检查一次，存储结果
- ✅ **响应式控制**：基于 `isManager` 状态自动更新 UI

### 归档过滤优化

- ✅ **数据库层过滤**：使用 where 条件，减少数据传输
- ✅ **索引优化**：建议为 `archived` 字段添加索引

---

## 安全考虑

### 上传安全

- ✅ **文件大小限制**：前端 + 云端双重检查
- ✅ **文件类型验证**：仅接受图片格式
- ✅ **存储路径隔离**：按项目ID分目录存储
- ✅ **访问控制**：仅管理员可上传/删除

### 权限安全

- ✅ **前端验证**：禁用非管理员的编辑操作
- ⚠️ **后端验证**：建议在云函数中添加权限校验
- ✅ **角色检查**：基于 managers 数组验证身份

### 数据安全

- ✅ **软删除**：归档不删除数据
- ✅ **时间戳记录**：记录所有操作时间
- ✅ **二次确认**：危险操作需用户确认

---

## 待办事项和改进建议

### 短期改进

- [ ] **云函数权限验证**：在后端添加权限校验
- [ ] **图片裁剪**：支持封面图片裁剪和调整
- [ ] **批量归档**：支持批量归档多个项目
- [ ] **归档列表**：创建专门的归档项目列表页面

### 中期改进

- [ ] **封面模板**：提供默认封面模板库
- [ ] **项目图标**：支持纯图标模式（小尺寸）
- [ ] **权限角色细化**：区分 owner/admin/member/viewer
- [ ] **操作日志**：记录封面更换、归档等操作

### 长期改进

- [ ] **自动归档**：长期无活动项目自动归档
- [ ] **归档提醒**：归档前提醒相关成员
- [ ] **数据导出**：归档项目数据导出为 JSON/PDF
- [ ] **权限组**：支持自定义权限组和角色

---

## 测试清单

### 功能测试

#### 封面上传
- [x] 选择图片成功上传
- [x] 大于 2MB 文件被拒绝
- [x] 上传进度提示正常
- [x] 封面预览正确显示
- [x] 删除封面成功
- [x] 云存储文件正确清理

#### 归档功能
- [x] 管理员可归档项目
- [x] 普通成员无归档按钮
- [x] 归档后项目从列表消失
- [x] 取消归档后项目重新出现
- [x] 归档时间正确记录

#### 权限控制
- [x] 管理员可编辑所有字段
- [x] 普通成员输入框禁用
- [x] 普通成员看到权限提示
- [x] 普通成员保存按钮禁用
- [x] 普通成员无法上传封面
- [x] 普通成员无归档设置区域

### 边界测试

- [x] 未登录用户访问
- [x] 项目无管理员
- [x] 项目无成员
- [x] 上传空文件
- [x] 重复归档操作
- [x] 快速切换用户

### 响应式测试

- [x] 移动端布局正常
- [x] 平板端布局正常
- [x] 桌面端布局正常
- [x] 封面预览响应式
- [x] 权限提示响应式

---

## 总结

本次更新成功为项目管理系统添加了三个重要的高级功能：

### ✅ 项目封面/图标上传
- 支持自定义项目封面
- 云存储集成
- 图片预览和管理

### ✅ 项目归档功能
- 归档不活跃项目
- 保留数据可访问
- 自动过滤归档项目

### ✅ 权限控制
- 基于角色的访问控制
- 管理员/成员权限区分
- UI 状态自动控制

这些功能显著提升了项目管理的灵活性和安全性，为用户提供了更专业的项目管理体验！🎉

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 2.2.0 | 2025-11-17 | ✅ 新增封面上传功能<br>✅ 新增项目归档功能<br>✅ 新增权限控制<br>✅ 更新数据库 Schema |
| 2.1.5 | 2025-11-15 | 基础项目设置功能 |
