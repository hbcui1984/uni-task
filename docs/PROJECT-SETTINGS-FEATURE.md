# 项目设置功能升级

> 更新日期：2025-11-17
> 页面：`pages/opendb-projects/edit.vue`

---

## 功能概述

将原有简陋的项目编辑页面升级为功能完善的**项目设置中心**，支持项目信息管理、统计查看和成员管理。

---

## 新增功能

### 1. **完善的基本信息编辑**

#### 项目名称
- ✅ 必填字段，2-50 字符限制
- ✅ 实时验证
- ✅ 占位符提示

#### 项目描述（新增）
- ✅ 多行文本域
- ✅ 最多 500 字符
- ✅ 字符计数（maxlength）
- ✅ 自适应高度（可调整大小）

### 2. **项目统计面板（新增）**

实时显示项目数据统计：

| 统计项 | 说明 |
|--------|------|
| **成员数量** | 项目管理员 + 普通成员总数 |
| **任务总数** | 项目下所有任务数量 |
| **已完成** | 状态为"已完成"的任务数 |
| **完成率** | 已完成任务 / 总任务数 × 100% |

**特性**：
- 📊 4 宫格卡片展示
- 🎨 渐变绿色背景
- ✨ 悬浮动画效果
- 📱 移动端 2×2 网格，PC 端 1×4 横向布局

### 3. **成员管理快捷入口（新增）**

#### 成员头像展示
- 显示前 5 位成员的头像（圆形）
- 头像显示成员昵称首字母
- 超过 5 人显示 "+N" 更多标记
- 渐变绿色背景
- 悬浮放大效果

#### 功能按钮
- "管理成员" 按钮跳转到成员管理页面
- 支持添加/移除成员
- 修改后自动刷新统计数据

---

## 界面设计

### 布局结构

```
┌──────────────────────────────────────┐
│  页面标题（绿色渐变背景）              │
│  项目设置 / 管理项目的基本信息和配置    │
├──────────────────────────────────────┤
│  基本信息                             │
│  ├─ 项目名称  [输入框]                │
│  └─ 项目描述  [文本域]                │
├──────────────────────────────────────┤
│  项目统计                             │
│  ┌────┬────┬────┬────┐               │
│  │成员│任务│完成│完成率│              │
│  │ 5 │ 23 │ 15 │ 65%│               │
│  └────┴────┴────┴────┘               │
├──────────────────────────────────────┤
│  成员管理          [管理成员 →]       │
│  ●●●●● +2  共 7 名成员                │
├──────────────────────────────────────┤
│  [取消]  [保存修改]                   │
└──────────────────────────────────────┘
```

### 配色方案

| 元素 | 颜色 |
|------|------|
| 页面标题背景 | `linear-gradient(135deg, #42b983, #359568)` |
| 分区标题 | `#2c3e50` + `#42b983` 图标 |
| 统计卡片背景 | `linear-gradient(135deg, #f0fdf7, #e6fcf5)` |
| 统计数值 | `#42b983` |
| 成员头像背景 | `linear-gradient(135deg, #42b983, #359568)` |
| 按钮边框/文字 | `#42b983` |

---

## 技术实现

### 数据获取

#### 1. 项目基本信息
```javascript
db.collection('opendb-projects').doc(id).get()
```

#### 2. 成员列表
```javascript
const memberIds = [...new Set([
  ...(formData.members || []),
  ...(formData.managers || [])
])]

db.collection('uni-id-users')
  .where({ _id: dbCmd.in(memberIds) })
  .field('_id, nickname, username')
  .get()
```

#### 3. 任务统计
```javascript
// 并行查询任务总数和已完成数
Promise.all([
  db.collection('opendb-task')
    .where({ project_id: this.formDataId })
    .count(),
  db.collection('opendb-task')
    .where({ project_id: this.formDataId, status: 2 })
    .count()
])
```

### 性能优化

- ✅ **并行加载**：`Promise.all` 同时获取成员列表和任务统计
- ✅ **去重处理**：使用 `Set` 合并管理员和成员 ID
- ✅ **按需查询**：仅查询必要字段（`field` 参数）
- ✅ **数据缓存**：成员列表和统计数据存储在组件 data 中

---

## 用户交互流程

### 编辑项目信息

```
用户点击"修改"按钮
    ↓
进入项目设置页面
    ↓
页面自动加载：
  - 项目基本信息
  - 成员列表
  - 任务统计
    ↓
用户修改项目名称/描述
    ↓
点击"保存修改"
    ↓
验证表单（2-50字符，500字符描述）
    ↓
提交到数据库
    ↓
成功提示 → 返回上一页
```

### 管理成员

```
用户点击"管理成员"按钮
    ↓
跳转到成员管理页面
    ↓
添加/移除成员
    ↓
返回项目设置页面
    ↓
自动刷新成员列表和统计数据
```

---

## 响应式设计

### 移动端（< 768px）

- 容器最大宽度：720px
- 统计网格：2×2
- 成员头像：36px
- 标题字号：24px
- 按钮宽度：弹性布局

### 平板端（768px - 1200px）

- 容器最大宽度：880px
- 统计网格：1×4
- 成员头像：40px
- 标题字号：28px
- 内边距增加

### 桌面端（> 1200px）

- 容器最大宽度：1000px
- 更大的内边距和字号
- 优化的按钮尺寸
- 更宽松的布局

---

## 数据结构

### formData

```javascript
{
  name: "项目名称",           // 必填
  description: "项目描述",    // 可选
  members: [],              // 成员 ID 数组
  managers: []              // 管理员 ID 数组
}
```

### projectStats

```javascript
{
  memberCount: 5,       // 成员总数
  taskCount: 23,        // 任务总数
  completedCount: 15,   // 已完成任务数
  completionRate: 65    // 完成率（百分比）
}
```

### memberList

```javascript
[
  {
    _id: "user_id_1",
    nickname: "张三",
    username: "zhangsan"
  },
  ...
]
```

---

## 验证规则

### 项目名称
- **必填**：不能为空
- **长度**：2-50 字符
- **去空格**：自动 trim 首尾空格

### 项目描述
- **可选**：允许为空
- **长度**：最多 500 字符
- **去空格**：自动 trim 首尾空格

---

## 错误处理

### 数据加载失败
```javascript
catch (err) {
  uni.showModal({
    content: err.message || '请求服务失败',
    showCancel: false
  })
}
```

### 成员列表加载失败
- 不影响主流程
- 控制台输出错误
- 显示"暂无成员"

### 统计数据加载失败
- 不影响主流程
- 控制台输出错误
- 不显示统计面板

---

## 样式特性

### 1. 渐变背景
- 页面标题：绿色渐变
- 统计卡片：浅绿渐变
- 成员头像：绿色渐变

### 2. 悬浮效果
```scss
&:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(66, 185, 131, 0.15);
}
```

### 3. 焦点样式
```scss
&:focus {
  border-color: #42b983;
  box-shadow: 0 0 0 3px rgba(66, 185, 131, 0.1);
}
```

### 4. 过渡动画
- 所有交互元素：`transition: all 0.25s ease`
- 统一动画时长：250ms
- 缓动函数：ease

---

## 与其他页面的集成

### 项目详情页 (`detail.vue`)

```javascript
// 点击"修改"按钮
handleUpdate() {
  uni.navigateTo({
    url: '../opendb-projects/edit?id=' + this._id,
    events: {
      refreshData: () => {
        this.$refs.udb.loadData({ clear: true })
      }
    }
  })
}
```

### 成员管理页 (`member.vue`)

```javascript
// 从设置页面跳转
handleManageMembers() {
  uni.navigateTo({
    url: './member?id=' + this.formDataId,
    events: {
      refreshData: () => {
        this.getDetail(this.formDataId)
      }
    }
  })
}
```

---

## 后续优化建议

### 1. **增强统计功能**
- [ ] 任务进度条可视化
- [ ] 逾期任务数量统计
- [ ] 近期活动趋势图
- [ ] 成员工作量分布

### 2. **项目设置扩展**
- [ ] 项目图标/封面上传
- [ ] 项目颜色标签
- [ ] 项目归档功能
- [ ] 项目模板应用
- [ ] 删除确认二次弹窗

### 3. **权限控制**
- [ ] 仅管理员可编辑项目信息
- [ ] 普通成员只读权限
- [ ] 操作日志记录

### 4. **数据导出**
- [ ] 导出项目报告（PDF）
- [ ] 导出任务清单（Excel）
- [ ] 导出成员列表

### 5. **性能优化**
- [ ] 统计数据缓存（5分钟 TTL）
- [ ] 虚拟滚动（成员列表很长时）
- [ ] 懒加载统计数据

---

## 测试要点

### 功能测试
- [x] 项目名称修改成功
- [x] 项目描述修改成功
- [x] 统计数据正确显示
- [x] 成员头像正确显示
- [x] 跳转成员管理页面
- [x] 取消按钮返回上一页
- [x] 表单验证正常工作

### 边界测试
- [x] 空项目（无成员、无任务）
- [x] 超过 5 个成员显示 "+N"
- [x] 项目名称 2 字符（最小）
- [x] 项目名称 50 字符（最大）
- [x] 项目描述 500 字符（最大）

### 响应式测试
- [x] 移动端布局正常
- [x] 平板端布局正常
- [x] 桌面端布局正常
- [x] 统计网格自适应

### 交互测试
- [x] 悬浮效果正常
- [x] 焦点样式正常
- [x] 按钮点击响应
- [x] 加载状态提示

---

## 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0 | 2025-11-17 | 初始版本，基础编辑功能 |
| 2.0 | 2025-11-17 | ✅ 新增项目描述字段<br>✅ 新增项目统计面板<br>✅ 新增成员管理快捷入口<br>✅ UI 全面升级 |

---

## 总结

项目设置页面从简陋的单字段编辑升级为功能完善的设置中心：

✅ **信息更全面**：项目名称 + 描述
✅ **数据可视化**：统计面板直观展示项目状态
✅ **操作更便捷**：成员管理快捷入口
✅ **界面更美观**：渐变背景 + 动画效果
✅ **体验更友好**：响应式设计 + 清晰的视觉层次

现在用户可以在一个页面内完成项目的所有设置操作，大幅提升了管理效率！🎉
